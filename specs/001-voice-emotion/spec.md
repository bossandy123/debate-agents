# Feature Specification: 语音与情绪表达功能

**Feature Branch**: `001-voice-emotion`
**Created**: 2026-01-02
**Status**: Draft
**Input**: User description: "我现在想增加语音功能，最好带上情绪。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基础语音播放功能 (Priority: P1)

用户在观看辩论时，希望能够听到 AI 辩手的语音发言，而不是仅仅阅读文字。这提供了更自然的辩论观看体验，特别适合长时间观看或移动端使用场景。

**Why this priority**: 这是核心价值功能，语音功能的基础。没有这个功能，后续的情绪表达无法实现。这是用户最直接的需求，能够独立提供完整的语音播放体验。

**Independent Test**: 可以通过播放任意一段 AI 辩手的发言进行完整测试，验证用户能够听到清晰的语音输出，并能控制播放/暂停、音量调节等基本操作。

**Acceptance Scenarios**:

1. **Given** 用户正在观看一场进行中的辩论，**When** AI 辩手发表言论时，**Then** 系统自动将文字转换为语音并播放
2. **Given** 用户正在观看回放，**When** 用户点击任意历史发言的播放按钮，**Then** 系统播放该段发言的语音
3. **Given** 语音正在播放，**When** 用户点击暂停按钮，**Then** 语音立即停止播放
4. **Given** 语音正在播放，**When** 用户调整音量滑块，**Then** 播放音量实时变化

---

### User Story 2 - 情绪化语音表达 (Priority: P2)

用户希望 AI 辩手的语音能够表达出情绪，使辩论更加生动有趣。当辩手强烈反驳时语调激昂，当进行理性分析时语调平稳，当总结时语调从容。这大大增强了辩论的观赏性和代入感。

**Why this priority**: 这是"最好带上"的需求，能够显著提升用户体验，但不是核心功能。需要在基础语音功能稳定后再实现。

**Independent Test**: 可以通过播放一段包含明显情绪色彩的发言（如激烈反驳）进行测试，验证语音的语调、语速、音高能够反映出文本中的情绪。

**Acceptance Scenarios**:

1. **Given** AI 辩手正在进行激烈反驳，**When** 语音播放该段发言，**Then** 语音语调激昂、语速较快、音量较大
2. **Given** AI 辩手正在进行理性分析，**When** 语音播放该段发言，**Then** 语音语调平稳、语速适中
3. **Given** AI 辩手表达不确定或犹豫，**When** 语音播放该段发言，**Then** 语音包含适度的停顿和疑问语调
4. **Given** 发言内容包含强调标记（如粗体、感叹号），**When** 语音播放，**Then** 对应词汇的语音强度增加

---

### User Story 3 - 语音个性化设置 (Priority: P3)

不同的用户有不同的语音偏好。用户希望能够选择不同的语音风格（男声/女声、不同年龄段、不同口音），以及调整语音播放的全局设置。

**Why this priority**: 这是锦上添花的功能，能够提升用户满意度，但不影响核心体验。可以在基础功能和情绪表达都稳定实现后再考虑。

**Independent Test**: 可以通过修改语音设置并播放同一段发言，验证不同的语音风格和设置能够正确应用。

**Acceptance Scenarios**:

1. **Given** 用户在设置页面，**When** 用户选择"女声"语音风格，**Then** 之后播放的所有发言都使用女声
2. **Given** 用户在设置页面，**When** 用户调整播放速度为"1.5x"，**Then** 语音播放速度明显加快
3. **Given** 用户为正方辩手选择了"成熟男声"，为反方辩手选择了"青年女声"，**When** 辩论进行时，**Then** 双方辩手使用各自指定的语音
4. **Given** 用户关闭了"自动播放"设置，**When** AI 发表新言论，**Then** 系统不自动播放语音，仅显示文字

---

### User Story 4 - 语音历史回顾 (Priority: P4)

用户在复盘报告页面，希望能够通过语音方式重新听取整个辩论过程或关键轮次，就像听播客一样回顾精彩辩论。

**Why this priority**: 这是增值功能，能够扩展使用场景（如通勤时听辩论回放），但不影响主要的观看体验。

**Independent Test**: 可以通过在复盘报告页面点击"播放整场"按钮，验证系统能够连续播放多轮发言，并提供播放控制。

**Acceptance Scenarios**:

1. **Given** 用户在复盘报告页面，**When** 用户点击"播放整场"按钮，**Then** 系统按顺序连续播放所有发言，并在轮次间自动切换
2. **Given** 系统正在播放整场辩论，**When** 用户点击"上一轮"/"下一轮"按钮，**Then** 播放位置跳转到对应轮次
3. **Given** 系统正在播放，**When** 用户切换到其他应用或浏览器标签，**Then** 语音继续播放（支持后台播放）
4. **Given** 系统正在播放整场，**When** 用户点击"跳过本轮"，**Then** 系统停止当前发言并立即开始下一轮

---

### Edge Cases

- **网络中断**: 当语音生成服务因网络问题不可用时，系统应优雅降级为仅文字展示，并提示用户语音功能暂时不可用
- **超长发言**: 当单次发言超过语音服务的长度限制（如某些服务限制 5000 字符）时，系统应将发言分段处理并连续播放
- **特殊字符**: 当发言包含特殊字符、代码块、公式等不适合朗读的内容时，系统应跳过或进行合适处理（如代码块不朗读）
- **并发播放**: 当用户快速切换多个发言的播放按钮时，系统应停止当前播放并开始新的播放，避免多个语音同时播放
- **浏览器兼容性**: 当用户使用不支持语音 API 的浏览器时，系统应隐藏语音功能或提示升级浏览器
- **语音服务限流**: 当语音服务的 API 调用频率达到限制时，系统应排队处理请求并提示用户稍等
- **多标签页**: 当用户在多个标签页同时打开同一场辩论时，只有一个标签页的语音能够播放，避免干扰
- **设备限制**: 当用户设备处于静音模式或未连接音频输出设备时，系统应检测并提示用户

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能够将 AI 辩手、裁判、观众的文字发言转换为语音输出
- **FR-002**: 系统必须在实时观看页面支持自动播放新产生的发言语音
- **FR-003**: 系统必须为每段历史发言提供手动播放按钮
- **FR-004**: 系统必须提供播放控制功能，包括播放/暂停、停止、音量调节
- **FR-005**: 系统必须在语音播放时显示视觉反馈（如波形动画或播放进度条）
- **FR-006**: 系统必须能够根据发言内容的情绪特征调整语音的语调、语速、音高
- **FR-007**: 系统必须支持至少 3 种基本情绪类型：激烈（反驳）、平稳（立论）、从容（总结）
- **FR-008**: 系统必须能够识别文本中的强调标记（如粗体、大写、感叹号）并相应调整语音强度
- **FR-009**: 系统必须允许用户为不同的辩手角色设置不同的语音风格（正方/反方/裁判）
- **FR-010**: 系统必须提供全局语音设置选项，包括自动播放开关、默认音量、播放速度
- **FR-011**: 系统必须在复盘报告页面支持连续播放多轮发言
- **FR-012**: 系统必须支持在播放过程中跳转到指定轮次
- **FR-013**: 系统必须保存用户的语音偏好设置
- **FR-014**: 系统必须在语音服务不可用时优雅降级为文字模式
- **FR-015**: 系统必须将语音生成和播放过程对用户透明显示（如"正在生成语音..."、"播放中"状态）
- **FR-016**: 系统必须缓存已生成的语音内容，避免重复生成相同发言的语音
- **FR-017**: 系统必须支持暂停当前播放后从暂停位置继续播放
- **FR-018**: 系统必须在播放过程中显示当前播放的轮次和发言者信息
- **FR-019**: 系统必须提供语音功能的开启/关闭全局开关
- **FR-020**: 系统必须在语音播放结束时提供视觉反馈（如播放按钮恢复为初始状态）

### Quality Requirements

- **QR-001**: 语音生成延迟应在发言内容产生后的 3-5 秒内完成
- **QR-002**: 语音播放的启动延迟应在 < 500ms 内
- **QR-003**: 情绪识别准确率应达到 85%
- **QR-004**: 语音质量应清晰可辨，无明显机械感或卡顿
- **QR-005**: 语音服务的响应时间应在可接受范围内（p95 < 3 秒）
- **QR-006**: 系统应支持至少 95% 的浏览器（现代浏览器）
- **QR-007**: 语音缓存策略应有效减少重复生成，缓存命中率 > 80%
- **QR-008**: 语音功能不应影响辩论的核心性能（如辩论生成速度、页面加载速度）

### User Experience Requirements

- **UXR-001**: 语音控制界面应直观易懂，新用户无需指导即可使用
- **UXR-002**: 播放状态的视觉反馈应清晰明显，用户一眼就能看出是否正在播放
- **UXR-003**: 语音切换应流畅，无明显停顿或爆音
- **UXR-004**: 当语音功能不可用时，错误提示应友好且提供解决方案
- **UXR-005**: 用户设置应即时生效，无需刷新页面
- **UXR-006**: 在移动端设备上，语音控制按钮应易于触摸（最小点击区域 44x44 px）
- **UXR-007**: 自动播放功能应有明显的视觉指示，用户能清楚知道是否开启
- **UXR-008**: 语音播放进度条应支持拖拽跳转

### Performance Requirements

- **PR-001**: 语音生成服务的 API 调用响应时间应在 p95 < 3000ms 内
- **PR-002**: 语音缓存的存储空间应合理管理，避免占用过多本地存储（建议限制在 100MB 以内）
- **PR-003**: 语音播放不应影响页面其他交互的响应速度
- **PR-004**: 连续播放多轮发言时，轮次间的切换延迟应 < 500ms
- **PR-005**: 语音播放的内存占用应合理，单场辩论的语音数据内存占用 < 50MB

### Documentation Requirements

- **DR-001**: 所有功能规格说明必须使用中文编写
- **DR-002**: 用户界面的语音相关文本和提示必须使用中文
- **DR-003**: 语音设置选项的说明必须清晰易懂
- **DR-004**: 技术实现文档可使用中文或英文

### Key Entities

- **VoiceProfile (语音配置)**: 代表单个 Agent（辩手、裁判、观众）的语音配置
  - 关联的 Agent ID
  - 语音风格（男声/女声、年龄特征）
  - 情绪参数范围（语调、语速、音高）
  - 默认音量设置

- **VoiceCache (语音缓存)**: 已生成的语音文件缓存
  - 关联的消息 ID 或发言内容哈希值
  - 语音文件存储位置或 URL
  - 生成时间戳
  - 情绪标签
  - 文件大小

- **VoiceSettings (用户语音设置)**: 用户的语音偏好设置
  - 自动播放开关
  - 默认音量
  - 播放速度
  - 全局语音开关
  - 后台播放开关

- **EmotionAnalysis (情绪分析结果)**: 对发言内容的情绪分析
  - 关联的消息 ID
  - 主情绪类型（激烈/平稳/从容）
  - 情绪强度评分（0-1）
  - 语调参数
  - 语速参数
  - 音高参数

- **PlaybackSession (播放会话)**: 记录连续播放的状态
  - 会话 ID
  - 当前播放的消息 ID
  - 播放状态（播放中/暂停/停止）
  - 播放列表（消息 ID 序列）
  - 当前播放进度

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在发言产生后 5 秒内听到语音输出，延迟不超过用户容忍度
- **SC-002**: 情绪化语音能够准确传达发言中的情绪，用户满意度评分达到 4/5 或更高
- **SC-003**: 语音功能的开启率（在可用的用户中）达到 60% 以上，证明功能被用户广泛接受
- **SC-004**: 用户平均每场辩论使用语音功能的时间超过辩论总时长的 50%，证明语音功能具有持续使用价值
- **SC-005**: 语音服务的稳定性达到 99.5%，服务不可用导致的功能降级次数 < 0.5%
- **SC-006**: 语音缓存有效减少 API 调用，重复内容的缓存命中率 > 80%
- **SC-007**: 用户能够在 10 秒内完成首次语音设置配置（从打开设置到成功播放第一段语音）
- **SC-008**: 移动端用户和桌面端用户都能流畅使用语音功能，移动端使用占比 > 30%
- **SC-009**: 语音功能的用户反馈中正面评价占比 > 80%
- **SC-010**: 语音播放不影响辩论页面的其他功能性能，页面加载时间增加 < 10%

## Assumptions

1. 用户主要使用现代浏览器（Chrome 90+、Firefox 88+、Safari 14+、Edge 90+），这些浏览器支持必要的音频 API
2. 用户设备具备基本的音频输出能力（扬声器或耳机）
3. 现有的辩论系统架构支持在消息生成后触发语音生成流程
4. 有可靠的第三方语音合成服务（TTS）可用，支持情绪参数调节
5. 用户在大多数使用场景下有网络连接支持访问语音服务
6. 现有的实时推送系统（SSE）能够承载语音状态事件的传输
7. 数据库能够扩展存储语音相关的配置和缓存信息
8. 用户对于基础语音功能的需求优先于高级自定义功能
9. 发言内容的情绪特征可以通过文本分析进行合理推断
10. 语音服务的成本在可接受范围内，或者可以通过缓存策略控制成本

## Dependencies

1. **第三方 TTS 服务**: 需要选择支持中文、情绪参数调节的语音合成服务（如 Azure Speech Services、Amazon Polly、Google Cloud TTS 或国产替代服务）
2. **浏览器音频 API**: 依赖 Web Audio API 或 Speech Synthesis API 的支持
3. **情绪分析服务**: 可能需要集成文本情绪分析服务，或基于现有 LLM 进行情绪识别
4. **缓存存储**: 需要合适的缓存方案（IndexedDB、LocalStorage 或服务端缓存）
5. **现有辩论系统**: 依赖于现有的消息生成、SSE 推送、数据存储等基础设施
