# Phase 0: 技术调研 - 语音与情绪表达功能

**Date**: 2026-01-02
**Feature**: 001-voice-emotion
**Status**: Completed

## 调研目标

根据用户需求"独立TTS层，这里国内有哪些可选方案"，调研国内主流TTS服务提供商，重点关注：
1. 情绪参数支持能力
2. API调用方式和集成复杂度
3. 成本和定价模式
4. 性能指标（延迟、并发）
5. 与现有系统的兼容性

---

## 决策摘要

| 决策项 | 选择方案 | 核心理由 |
|--------|---------|----------|
| **TTS服务提供商** | 字节跳动豆包语音（首选）+ 阿里云通义千问（备选） | 豆包情绪支持最全面（7种情绪类型），阿里云性价比高 |
| **情绪识别方案** | 基于现有LLM进行文本情绪分析 | 无需额外服务，利用现有基础设施 |
| **音频缓存策略** | 客户端IndexedDB + 服务端对象存储 | 平衡性能和成本，支持离线播放 |
| **播放器方案** | HTML5 Audio API + Howler.js封装 | 兼容性好，API简单，满足需求 |
| **实时推送扩展** | 扩展现有SSE系统增加语音状态事件 | 复用现有架构，最小化改动 |

---

## 详细调研结果

### 1. TTS服务提供商对比

#### 1.1 字节跳动豆包语音 ⭐ **推荐首选**

**情绪支持能力**：
- 支持7种情绪类型：`angry`（生气）、`happy`（开心）、`neutral`（平静）、`sad`（悲伤）、`surprise`（惊讶）、`fear`（恐惧）、`disgust`（厌恶）
- `emotion_scale` 参数可调节情绪强度（0.0-1.0）
- 模型能根据上下文自动预测文本情绪和语调
- 支持声音复刻功能（10-20秒音频即可生成定制音色）

**API参数示例**：
```json
{
  "text": "这个观点完全错误！",
  "voice_type": "zh_female_qingxin",
  "emotion": "angry",
  "emotion_scale": 0.8,
  "speed": 1.2,
  "volume": 1.0
}
```

**定价**：
- 大模型语音合成：5元/万字符
- 大模型声音复刻：8元/万字符
- 支持资源包预付费和按调用量后付费
- 提供免费试用额度

**性能**：
- 支持流式输出
- 响应时间：< 3秒（符合QR-001要求）

**优点**：
- ✅ 情绪支持最全面，完全覆盖FR-007要求（3种基本情绪）
- ✅ 情绪强度可调，满足FR-006要求
- ✅ 流式输出支持，降低启动延迟
- ✅ 文档清晰，SDK完善（Node.js、Python、Go等）

**缺点**：
- ⚠️ 价格相对较高（5元/万字符）
- ⚠️ 需要额外评估网络稳定性

**文档链接**：[豆包语音合成API文档](https://www.volcengine.com/docs/6561/1257584)

---

#### 1.2 阿里云通义千问TTS ⭐ **推荐备选**

**情绪支持能力**：
- 基于大模型的声音复刻技术
- 生成高度自然且带情绪的定制音色
- 支持多语言及方言（中文、英文、粤语等）
- 文档未明确提及情绪参数，但大模型版本可能支持情绪推理

**定价**：
- 实时语音合成（北京）：1元/万字符
- 长文本语音合成：3元/万字（基准价）
- 批量有折扣（1000-3999万字：2.40元/万字；4000万字以上：2.20元/万字）

**性能**：
- 支持流式输出
- 限流：180 RPM
- 响应时间：< 3秒

**优点**：
- ✅ 价格优势明显（仅为豆包的1/5）
- ✅ 阿里云生态稳定可靠
- ✅ 支持长文本合成（适合超长发言处理）
- ✅ 声音复刻功能强大

**缺点**：
- ⚠️ 情绪参数支持不明确（需进一步确认）
- ⚠️ 可能需要额外的情绪识别层

**文档链接**：[阿里云语音合成文档](https://help.aliyun.com/zh/model-studio/qwen-tts)

---

#### 1.3 腾讯云语音合成

**情绪支持能力**：
- 支持SSML标记语言
- 部分音色支持情绪分类（如"爱小星"音色：中性、广播、平静、兴奋）
- 可自定义音量、语速、音调等参数

**定价**：
- 预付费+后付费模式
- 标准音色与精品音色价格不同（精品音色比标准音色高约50%）
- 具体价格需参考官方文档

**优点**：
- ✅ SSML支持提供更细粒度控制
- ✅ 腾讯云生态稳定

**缺点**：
- ⚠️ 情绪支持不如豆包全面
- ⚠️ 定价信息不够透明

---

#### 1.4 百度智能云语音合成

**情绪支持能力**：
- 基于大模型升级的语音合成
- 能智能预测文本的情绪、语调等信息
- 自动匹配相应的情感表达

**定价**：
- 次数包预付费模式
- 主流厂商中价格相对较低

**优点**：
- ✅ 价格优势
- ✅ 情绪智能预测

**缺点**：
- ⚠️ 情绪参数不够明确
- ⚠️ 定价信息不够透明

---

### 2. 技术方案选型

#### 2.1 TTS集成方案

**方案A：直接集成TTS API（推荐）**

```
辩论消息生成 → 情绪分析 → TTS API调用 → 音频URL返回 → 缓存 → 播放
```

**优点**：
- 实现简单，API调用直接
- 厂商负责模型更新和维护
- 成本可控，按需付费

**缺点**：
- 依赖第三方服务稳定性
- 网络延迟影响体验

**方案B：自建TTS服务（不推荐）**

```
辩论消息生成 → 情绪分析 → 本地TTS模型 → 音频生成 → 播放
```

**优点**：
- 完全自主可控
- 无外部API调用成本

**缺点**：
- 需要GPU资源，成本高
- 模型训练和维护复杂
- 音质可能不如商业方案

**决策**：采用**方案A**，直接集成TTS API

---

#### 2.2 情绪识别方案

**方案A：基于现有LLM分析（推荐）**

```typescript
// 使用现有的辩论LLM进行情绪分析
const emotionPrompt = `
分析以下发言的情绪特征，返回JSON格式：
{
  "emotion": "intense|neutral|calm",
  "intensity": 0.0-1.0,
  "reasoning": "判断依据"
}

发言内容：${message}
`;

const emotionAnalysis = await llm.call(emotionPrompt);
```

**优点**：
- 无需额外服务成本
- 利用现有LLM的理解能力
- 可根据辩论场景定制分析逻辑

**缺点**：
- 增加LLM调用次数
- 分析准确率需要验证

**方案B：集成专业情绪分析API**

使用如百度NLP情绪分析、阿里云NLP等专用服务

**优点**：
- 专业模型，准确率高
- 响应速度快

**缺点**：
- 额外成本
- 需要额外集成工作

**决策**：采用**方案A**，基于现有LLM进行情绪分析，准确率目标85%（QR-003）

---

#### 2.3 音频缓存策略

**多层缓存架构**：

```
1. 内存缓存（Node.js Map）
   └─ 当前播放的音频数据
   └─ TTL: 5分钟

2. 客户端缓存（IndexedDB）
   └─ 已播放过的音频文件
   └─ 限制: 100MB（PR-002）

3. 服务端缓存（对象存储/OSS）
   └─ 所有生成过的音频文件
   └─ 永久保存，定期清理
```

**缓存键设计**：
```typescript
const cacheKey = `${messageId}_${emotionType}_${voiceProfile}`;
// 或基于内容哈希
const cacheKey = `hash:${md5(text + emotionType + voiceProfile)}`;
```

**优点**：
- 减少TTS API调用，降低成本
- 提升播放速度（满足< 500ms启动延迟）
- 支持离线播放

---

#### 2.4 音频播放方案

**方案选择：HTML5 Audio API + Howler.js封装**

**为什么选择Howler.js**：
- ✅ 统一的API，兼容所有主流浏览器
- ✅ 自动降级到合适的音频格式
- ✅ 支持音频流和精灵图（sprite）
- ✅ 内置音量控制和淡入淡出
- ✅ 支持播放进度控制

**基础用法**：
```typescript
import { Howl } from 'howler';

const sound = new Howl({
  src: ['/api/voices/audio.mp3'],
  html5: true, // 强制使用HTML5 Audio（支持流式播放）
  volume: 0.8,
  rate: 1.0,
  onplay: () => {
    // 显示播放状态
  },
  onend: () => {
    // 重置播放状态
  }
});

sound.play();
```

---

#### 2.5 SSE实时推送扩展

**扩展现有SSE系统，增加语音状态事件**：

```typescript
// 新增事件类型
type VoiceEvent =
  | { type: 'voice_generating'; data: { messageId: string } }
  | { type: 'voice_ready'; data: { messageId: string; audioUrl: string } }
  | { type: 'voice_playing'; data: { messageId: string; progress: number } }
  | { type: 'voice_error'; data: { messageId: string; error: string } };

// 客户端监听
eventSource.addEventListener('voice_ready', (event) => {
  const { messageId, audioUrl } = JSON.parse(event.data);
  // 预加载音频
  if (autoPlayEnabled) {
    playAudio(messageId, audioUrl);
  }
});
```

---

## 成本估算

### 场景假设
- 平均每场辩论：10轮 × 2方 = 20条发言
- 平均每条发言：200字
- 日均辩论场次：100场
- 缓存命中率：80%（SC-006要求）

### TTS成本计算

**使用豆包语音**：
- 日总字符数：100场 × 20条 × 200字 = 40万字
- 实际调用量（80%缓存）：40万 × 20% = 8万字
- 日成本：8万 ÷ 10000 × 5元 = 40元
- 月成本：40元 × 30天 = 1200元

**使用阿里云**：
- 月成本：8万 ÷ 10000 × 1元 × 30天 = 240元

**建议**：
- 初期使用阿里云通义千问（成本控制）
- 如情绪支持不足，切换至豆包语音

---

## 技术风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|----------|
| TTS服务不稳定 | 中 | 多厂商备选方案；优雅降级为文字模式 |
| 情绪识别准确率不达标 | 中 | 持续优化prompt；必要时集成专业情绪分析API |
| 音频缓存占用存储 | 低 | 设置缓存上限和过期策略；使用对象存储低成本方案 |
| 浏览器兼容性问题 | 低 | Howler.js提供良好兼容性；检测并提示不支持的浏览器 |
| 成本超预算 | 低 | 多层缓存策略；监控调用量；设置预算告警 |

---

## 性能目标验证

| 指标 | 要求 | 方案保障 |
|------|------|----------|
| 语音生成延迟 | 3-5秒 | TTS API响应时间<3秒；情绪分析<2秒 |
| 播放启动延迟 | < 500ms | 客户端预加载；内存缓存；HTTP/2 |
| 情绪识别准确率 | 85% | 使用现有LLM；持续优化prompt |
| 缓存命中率 | > 80% | 多层缓存；基于内容哈希的缓存键 |
| 系统可用性 | 99.5% | 多厂商备选；优雅降级 |

---

## 技术栈确认

- **TTS服务**：字节跳动豆包语音（首选）/ 阿里云通义千问（备选）
- **情绪分析**：现有LangChain + LLM
- **音频播放**：Howler.js
- **客户端缓存**：IndexedDB
- **服务端缓存**：OSS对象存储
- **实时推送**：扩展现有SSE系统
- **数据库**：SQLite（扩展现有表结构）

---

## 参考资料

1. [豆包语音合成API文档](https://www.volcengine.com/docs/6561/1257584)
2. [阿里云语音合成文档](https://help.aliyun.com/zh/model-studio/qwen-tts)
3. [腾讯云语音合成文档](https://cloud.tencent.com/document/product/1073/34112)
4. [Howler.js官方文档](https://howlerjs.com/)
5. [2025 中文语音合成全景调研](https://blog.csdn.net/qq_55666050/article/details/150945867)
6. [大厂语音合成成本对比](https://blog.csdn.net/soundcos/article/details/150351363)
