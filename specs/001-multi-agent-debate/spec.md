# 功能规格说明：多模型Agent辩论系统

**功能分支**: `001-multi-agent-debate`
**创建日期**: 2025-12-31
**状态**: 草稿
**输入**: PRD文档 `/prd/prd.md`

## 用户场景与测试 *(必填)*

### 用户故事 1 - 发起一场辩论 (优先级: P1)

用户输入一个辩题，系统自动分配正反方辩手Agent，按照严格规则进行多轮辩论，最终产生胜负结果和可解释的复盘报告。

**优先级理由**: 这是系统的核心价值，实现"认知对抗"的基本功能，没有辩论就无法体现多模型对抗的意义。

**独立测试**: 可以通过输入一个辩题（如"人工智能是否会取代人类工作"），验证系统能够完成从初始化到裁决的完整流程，并输出胜负结果和复盘报告。

**验收场景**:

1. **给定** 系统已启动，**当** 用户输入辩题"人工智能是否会取代人类工作"，**则** 系统应创建辩论会话、分配Agent、执行10轮辩论并输出结果
2. **给定** 辩论进行中，**当** 任何一方的Agent违规（如引入新论点的回合限制），**则** 裁判Agent应判定犯规并扣分
3. **给定** 辩论完成，**当** 裁判裁决完成，**则** 系统应输出包含胜负、关键转折回合、决胜论点、双方盲点、观众视角分歧的完整报告

---

### 用户故事 2 - 观众Agent参与辩论 (优先级: P2)

观众Agent可以在指定回合申请下场支持某一方，或响应主辩的求援请求，增加辩论的多样性和对抗深度。

**优先级理由**: 观众机制是PRD中的核心创新点，体现"拉盟友"的策略维度，但依赖基础辩论流程先实现。

**独立测试**: 可以在基础辩论流程上，验证观众Agent能否在Round 3-6期间申请下场并获裁判批准，以及主辩能否成功求援。

**验收场景**:

1. **给定** 辩论进入Round 3-6，**当** 观众Agent提交下场申请（包含支持立场、核心观点、新颖度），**则** 裁判应评估是否批准
2. **给定** 观众申请获批，**当** 该观众发言，**则** 发言内容应计入正式辩论记录
3. **给定** 主辩连续两轮未求援，**当** 主辩提交求援请求，**则** 系统应指定对应类型的观众响应
4. **给定** 主辩连续求援，**当** 尝试再次求援，**则** 请求应被拒绝

---

### 用户故事 3 - 查看历史辩论复盘 (优先级: P3)

用户可以查看已完成的辩论记录，包括完整的发言记录、评分明细、观众投票和裁判评语。

**优先级理由**: 存档和复盘是PRD强调的"结果必须可解释、可复盘、可存档"原则，但可以在核心辩论功能之后实现。

**独立测试**: 可以通过完成一场辩论后，查询数据库获取该辩论的完整记录，验证所有回合的发言、评分和投票数据都被正确保存。

**验收场景**:

1. **给定** 一场辩论已完成，**当** 用户查询该辩论ID，**则** 系统应返回完整的10轮发言记录
2. **给定** 查询辩论记录，**当** 获取评分数据，**则** 应包含每轮每个Agent在逻辑、反驳、清晰度、证据四个维度的得分
3. **给定** 查询辩论记录，**当** 获取观众投票，**则** 应显示每个观众的投票立场、置信度和理由

---

### 边界情况处理规则

- **API调用失败**: 当模型API调用失败或超时时，系统应重试3次，若仍失败则终止辩论并记录失败原因
- **平局判定**: 当裁判评分相等或观众投票平局时，以裁判评分作为最终决胜依据（裁判权重高于观众投票）
- **上下文超限**: 当辩论上下文超出模型token限制时，使用摘要压缩历史内容，保留核心论点
- **观众同时申请**: 当多个观众同时申请下场时，按申请时间顺序选择最先提交的观众
- **裁判判定能力不足**: 当观众申请超出裁判判定能力时，裁判应拒绝申请并说明理由

---

### 范围排除声明

- **Agent记忆**: Agent无跨辩论记忆功能，每场辩论完全独立。Agent在辩论过程中仅保留本场辩论的上下文，不学习或记录历史辩论的经验。此功能作为未来扩展方向。

## Clarifications

### Session 2025-12-31

- Q: Agent是否应该具有跨辩论的记忆能力？ → A: Agent无记忆功能，每场辩论独立（MVP范围，记忆作为未来扩展）

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须能够接受用户输入的辩题，并创建一个新的辩论会话
- **FR-002**: 系统必须为每场辩论分配正方和反方各1名主辩Agent，每个Agent绑定不同的模型实例
- **FR-003**: 系统必须支持配置观众池，包含至少5种不同类型的观众Agent（理性逻辑派、现实可行性派、技术前瞻派、风险厌恶派、情绪共鸣派）
- **FR-004**: 系统必须执行严格的10轮辩论流程，包括：立场构建(Round 1-2)、对抗与拉盟友(Round 3-6)、关键战役(Round 7-8)、终局攻防(Round 9)、总结陈词(Round 10)
- **FR-005**: 裁判Agent必须在每轮结束后对双方进行评分，评分维度包括逻辑一致性、针对性反驳、表达清晰度、论证有效性
- **FR-006**: 系统必须在Round 3-6期间支持观众申请下场机制，每轮最多允许1名观众发言
- **FR-007**: 系统必须支持主辩求援机制，但限制连续两轮不可求援
- **FR-008**: 系统必须在Round 10结束后执行最终裁决，裁判输出完整评分与评语
- **FR-009**: 系统必须在裁决后收集所有观众的投票，计算加权结果并产出胜者
- **FR-010**: 系统必须输出包含胜负结果、关键转折回合、决胜论点、双方盲点、观众视角分歧的复盘报告
- **FR-011**: 系统必须将所有辩论数据持久化存储，包括辩论信息、Agent配置、回合记录、发言内容、评分、投票
- **FR-012**: 裁判Agent必须能够判定犯规行为，包括不引用对方论点、在禁止回合引入新观点、连续求援等
- **FR-013**: 系统必须在模型API调用失败时重试最多3次，若仍失败则终止辩论并记录失败原因
- **FR-014**: 系统必须在平局情况下以裁判评分作为最终决胜依据
- **FR-015**: 系统必须在上下文超出token限制时使用摘要压缩历史内容，保留核心论点
- **FR-016**: 当多个观众同时申请下场时，系统必须按申请时间顺序选择最先提交的观众
- **FR-017**: 当观众申请超出裁判判定能力时，裁判必须拒绝申请并说明理由
- **FR-018**: Agent必须仅保留本场辩论内的上下文记忆，不得跨辩论持久化或学习历史经验

### 质量需求

- **QR-001**: 代码必须使用严格类型检查，禁止隐式`any`类型
- **QR-002**: 公共API必须提供中文文档和使用示例
- **QR-003**: 核心辩论流程、裁判评分、观众投票等关键路径必须有自动化测试覆盖
- **QR-004**: 所有代码必须通过代码检查，零错误

### 用户体验需求

- **UXR-001**: 所有错误消息必须清晰且可操作，不得向用户暴露堆栈跟踪
- **UXR-002**: API响应必须遵循一致的结构格式
- **UXR-003**: 用户操作必须在200ms内提供反馈以保持响应性感知
- **UXR-004**: 辩论进度必须实时可追踪，用户可以查看当前回合和状态

### 性能需求

- **PR-001**: 单轮辩论的API调用必须在p95 < 30000ms内完成（考虑到LLM API调用时间）
- **PR-002**: 内存使用必须保持在500MB以下（不包括模型加载）
- **PR-003**: 辩论历史查询必须在p95 < 1000ms内返回结果
- **PR-004**: 完整10轮辩论（包括裁决和投票）必须在10分钟内完成

### 文档需求

- **DR-001**: 所有功能规格说明必须使用中文编写
- **DR-002**: 公共API文档必须提供中文文档和代码示例
- **DR-003**: 用户指南和帮助文本必须使用中文
- **DR-004**: 技术术语在无适当中文翻译时可保留英文

### 关键实体

- **辩论会话 (Debate)**: 代表一场完整的辩论，包含辩题、创建时间、状态、关联的Agent和回合
- **代理 (Agent)**: 参与辩论的AI实体，具有角色（辩手/裁判/观众）、绑定的模型提供商和模型名称、立场（正方/反方）。Agent仅在单场辩论内保留上下文，不跨辩论记忆
- **回合 (Round)**: 辩论的一个轮次，具有回合类型（立场构建/对抗/关键战役/终局攻防/总结陈词）和序列号
- **消息 (Message)**: Agent在某个回合中的发言内容，包含发送者、内容和时间戳
- **评分 (Score)**: 裁判对Agent在某回合的表现评分，包含逻辑、反驳、清晰度、证据四个维度
- **投票 (Vote)**: 观众Agent在最终阶段的投票，包含投票立场、置信度和理由
- **观众下场申请 (AudienceRequest)**: 观众申请下场的请求，包含意图（支持正方/反方）、核心观点、新颖度和置信度
- **求援请求 (HelpRequest)**: 主辩向观众求援的请求，包含请求类型（技术/伦理/实践）、目标观众类型和理由

## 成功标准 *(必填)*

### 可衡量成果

- **SC-001**: 用户可以在5分钟内完成一场10轮辩论并获得完整结果
- **SC-002**: 系统能够同时处理至少10场并发辩论而不出现性能下降
- **SC-003**: 90%的辩论能够顺利完成10轮流程而不出现API调用失败导致的提前终止
- **SC-004**: 裁判的评分结果在四个维度上的方差合理（不出现全满分或全零分的情况）
- **SC-005**: 观众投票的置信度分布符合正态分布（不出现极端倾向）
- **SC-006**: 复盘报告中的"关键转折回合"能够准确识别双方得分变化最大的回合
- **SC-007**: 系统能够在裁判判定犯规时准确记录违规类型并扣分
- **SC-008**: 辩论记录查询能够完整返回所有历史数据（发言、评分、投票）
