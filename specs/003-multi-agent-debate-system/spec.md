# Feature Specification: 多模型 Agent 辩论系统

**Feature Branch**: `003-multi-agent-debate-system`
**Created**: 2025-12-31
**Status**: Draft
**Input**: User description: "我想实现PRD中的功能"

## Clarifications

### Session 2025-12-31

- Q: 用户强调"实时响应各个AI的输出"——当前的UXR-001提到"辩论进度必须实时可见"，但这不够明确 → A: 用户能够在辩论进行中实时看到每一轮的发言和评分（流式输出模式），就像观看直播一样
- Q: 系统是每次辩论只运行一次（一次性任务），还是支持持久化的辩论服务（可以随时启动新辩论）？ → A: 持久化服务 - 系统作为长期运行的服务，用户可以随时创建新的辩论会话，支持多会话并行
- Q: 关于用户交互界面：系统提供什么样的用户交互方式？ → A: 仅Web界面 - 完整的Web应用，所有操作通过浏览器完成
- Q: 关于流式输出的实现方式：在Web界面上，如何实时展示Agent正在生成的内容？ → A: Server-Sent Events (SSE) - 服务器主动推送，浏览器自动接收和重连
- Q: 关于模型API调用的流式支持：当调用LLM API获取Agent回复时，是否使用流式模式获取Token？ → A: 流式模式 - 使用LLM API的streaming参数逐Token获取，立即通过SSE推送给用户

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 发起并配置辩论 (Priority: P1)

用户作为辩论发起者，能够创建一个新的辩论会话，配置辩题、正反立场定义、选择参与辩论的模型配置，并指定观众Agent的构成与权重。

**Why this priority**: 这是整个系统的入口功能，没有它就无法启动任何辩论。用户必须能够定义辩论的基本参数。

**Independent Test**: 可以独立测试通过创建一个简单的辩论配置（辩题 + 2个基础模型配置），验证系统能够初始化辩论会话并返回会话ID。

**Acceptance Scenarios**:

1. **Given** 用户提供了有效的辩题和正反立场定义，**When** 用户创建辩论会话，**Then** 系统生成唯一的会话ID并初始化所有必要的Agent实例
2. **Given** 用户配置了不完整的模型参数，**When** 用户尝试创建辩论会话，**Then** 系统返回清晰的错误信息指出缺失的必填参数
3. **Given** 用户指定的模型不可用（API密钥无效或配额耗尽），**When** 系统尝试初始化Agent，**Then** 系统在会话状态中标记相应模型为不可用并允许用户重新配置

---

### User Story 2 - 执行多轮辩论流程 (Priority: P1)

系统能够按照预定义的辩论规则（10轮，分为5个阶段）自动调度各个Agent轮流发言，确保回合顺序、发言权限和规则约束得到严格执行。

**Why this priority**: 这是系统的核心功能，实现了PRD中描述的认知对抗引擎的核心逻辑。

**Independent Test**: 可以独立测试通过预加载的模拟Agent（使用固定回复）来验证完整的10轮辩论流程能够正确执行。

**Acceptance Scenarios**:

1. **Given** 辩论会话已初始化完成，**When** 系统开始执行第1轮辩论，**Then** Pro方首先发言，然后Con方发言，发言内容被正确记录并关联到对应的轮次
2. **Given** 辩论进入第3-6轮（对抗与拉盟友阶段），**When** 某个观众Agent申请下场发言，**Then** 裁判Agent根据规则判定是否允许，并将结果记录到辩论流程中
3. **Given** 某个Agent在规定时间内未生成回复，**When** 系统等待超时，**Then** 系统记录超时事件并继续下一轮，同时标记该轮该方为未发言
4. **Given** 辩论进入第9轮（终局攻防），**When** Pro方尝试引入新观点，**Then** 裁判Agent判定为犯规并记录犯规行为

---

### User Story 3 - 裁判评分与裁决 (Priority: P1)

裁判Agent能够在每一轮结束后对双方的表现进行评分（逻辑一致性、针对性反驳、表达清晰度、论证有效性），并在所有轮次结束后生成最终裁决结果。

**Why this priority**: 裁判是系统中权力最大的Agent，评分和裁决是辩论系统的核心价值输出。

**Independent Test**: 可以独立测试通过提供预设的辩论内容让裁判Agent进行评分，验证评分输出的JSON结构正确且评分维度合理。

**Acceptance Scenarios**:

1. **Given** 一轮辩论双方都已完成发言，**When** 裁判Agent进行评分，**Then** 输出包含双方各维度得分的结构化JSON数据
2. **Given** 某一方发言中存在逻辑矛盾，**When** 裁判Agent评分，**Then** 该方的逻辑一致性得分显著降低，且裁判评论中明确指出矛盾点
3. **Given** 一方在反驳中直接回应了对方的核心论点，**When** 裁判Agent评分，**Then** 该方的针对性反驳得分较高
4. **Given** 某一方多次重复相同论点，**When** 裁判Agent评分，**Then** 该方的论证有效性得分降低，且评论中指出重复问题
5. **Given** 10轮辩论全部完成，**When** 裁判Agent生成最终裁决，**Then** 输出包含胜负结果、关键转折回合、决胜论点、双方盲点的完整分析

---

### User Story 4 - 观众投票与复盘 (Priority: P2)

在辩论结束后，所有观众Agent根据各自的偏好对辩论结果进行投票，系统汇总裁判评分和观众投票计算最终胜负，并生成可解释的复盘报告。

**Why this priority**: 观众投票体现了系统的"认知偏好模拟器"定位，多视角的复盘输出是系统的核心价值。

**Independent Test**: 可以独立测试通过预设观众Agent的投票结果和裁判评分，验证系统能正确计算加权结果并生成复盘报告。

**Acceptance Scenarios**:

1. **Given** 辩论所有轮次已完成，**When** 观众Agent进行投票，**Then** 每个观众输出包含投票立场、置信度和理由的结构化数据
2. **Given** 不同类型的观众Agent（理性逻辑派、现实可行性派等）完成投票，**When** 系统汇总结果，**Then** 复盘报告中展示不同观众视角的分歧分析
3. **Given** 裁判评分和观众投票都已完成，**When** 系统计算最终胜负，**Then** 系统按照裁判权重和观众权重的配置输出明确的胜方
4. **Given** 用户查询历史辩论记录，**When** 系统返回复盘数据，**Then** 包含完整的辩论过程、每轮评分、最终投票和胜负结果

---

### User Story 5 - 辩论数据持久化与查询 (Priority: P2)

系统能够将所有辩论相关数据（会话配置、Agent信息、每一轮发言、每轮评分、最终投票）持久化存储到SQLite数据库，并支持用户查询历史辩论记录。

**Why this priority**: 数据持久化是"结果必须可解释、可复盘、可存档"原则的基础，没有它无法实现复盘功能。

**Independent Test**: 可以独立测试通过执行完整辩论后查询数据库，验证所有数据表都包含预期的记录且关联关系正确。

**Acceptance Scenarios**:

1. **Given** 辩论会话创建完成，**When** 系统初始化，**Then** debates表中包含该会话记录，agents表中包含所有Agent配置
2. **Given** 每轮辩论完成，**When** 系统记录轮次数据，**Then** rounds表中包含轮次记录，messages表中包含该轮所有发言，scores表中包含裁判评分
3. **Given** 辩论完全结束，**When** 用户查询某轮的具体发言，**Then** 系统能够从数据库检索并按时间顺序展示该轮的所有发言
4. **Given** 辩论完全结束，**When** 用户查询完整的辩论记录，**Then** 系统能够从数据库检索并展示所有轮次的发言、评分和最终投票

---

### Edge Cases

- 如果某个模型在辩论过程中API调用失败（网络问题、配额耗尽、服务宕机），系统如何处理？
- 如果裁判Agent的评分输出不符合预期的JSON格式，系统如何处理？
- 如果所有观众Agent都投票给同一方但裁判评分相反，系统如何决定最终胜负？
- 如果辩论在某一轮陷入无限循环（双方反复重复相同论点），系统能否提前终止？
- 如果观众申请下场发言时网络超时，该轮如何继续？
- 如果用户配置的模型数量不足（比如只有1个模型），系统如何处理？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持用户创建辩论会话时配置辩题、正反立场定义
- **FR-002**: 系统必须支持配置至少2个不同的LLM模型作为正反方主辩
- **FR-003**: 系统必须支持配置多个观众Agent，每个Agent具有不同的偏好类型
- **FR-004**: 系统必须支持配置裁判Agent，裁判不能与辩手使用同一模型实例
- **FR-005**: 系统必须严格执行10轮辩论流程，分为5个阶段（立场构建、对抗与拉盟友、关键战役、终局攻防、总结陈词）
- **FR-006**: 系统必须确保每一轮的发言顺序为Pro先发言，Con后发言
- **FR-007**: 系统必须在第3-6轮允许观众Agent申请下场发言，每轮最多1人
- **FR-008**: 系统必须在第3-6轮允许主辩向观众求援，但连续两轮不可求援
- **FR-009**: 系统必须在第9轮禁止引入新观点，仅允许压缩与攻击对方漏洞
- **FR-010**: 系统必须禁止在第10轮新增事实，仅允许总结已有论点
- **FR-011**: 裁判Agent必须在每一轮结束后对双方进行评分，评分维度包括逻辑一致性、针对性反驳、表达清晰度、论证有效性
- **FR-012**: 裁判Agent必须能够判定犯规行为，包括引入新观点（在禁止阶段）、重复论点超过阈值等
- **FR-013**: 系统必须在辩论结束后收集所有观众Agent的投票，每个投票包含立场、置信度和理由
- **FR-014**: 系统必须根据裁判评分和观众投票的权重配置计算最终胜负
- **FR-015**: 系统必须生成包含胜负结果、关键转折回合、决胜论点、双方盲点、观众视角分歧的复盘报告
- **FR-016**: 系统必须将所有辩论数据持久化到SQLite数据库，数据表包括debates、agents、rounds、messages、scores、votes
- **FR-017**: 系统必须支持查询历史辩论记录，包括完整的轮次、发言、评分和投票数据
- **FR-018**: 系统必须处理模型API调用失败的情况，记录失败事件并允许继续辩论或重试
- **FR-019**: 系统必须为每个Agent生成唯一的标识符并记录其配置（模型提供商、模型名称、立场、风格标签等）
- **FR-020**: 系统必须提供完整的Web界面，用户通过浏览器完成所有操作（配置辩论、启动辩论、实时观看进度、查看结果、查询历史记录）
- **FR-021**: 系统必须支持实时流式输出，用户能够在辩论进行中实时看到每一轮的发言内容和裁判评分，无需等待整个辩论完成
- **FR-023**: 系统必须使用Server-Sent Events (SSE)协议实时推送Agent生成的内容，浏览器自动接收并展示，支持断线重连
- **FR-026**: 系统必须使用LLM API的流式模式（streaming参数）逐Token获取Agent回复，获取到Token后立即通过SSE推送给用户
- **FR-024**: 系统必须作为持久化服务运行，支持用户随时创建新的辩论会话，无需重启系统
- **FR-025**: 系统必须支持多个独立的辩论会话并行运行，各会话之间互不干扰
- **FR-022**: 系统必须提供模型配置管理功能，支持通过环境变量或配置文件设置API密钥和模型参数
- **FR-027**: 系统必须在辩论观看页面顶部展示正反方的立场定义
- **FR-028**: 系统必须支持将辩论消息按轮次分组展示（画布式布局）
- **FR-029**: 系统必须支持 Markdown 格式渲染 LLM 的输出内容（包括列表、粗体、代码块、引用等）
- **FR-030**: 系统必须在 SSE 实时推送中包含 `round_id` 字段，确保前端能正确按轮次分组
- **FR-031**: 系统必须在画布卡片上显示悬浮评分按钮，点击可查看该轮详细评分
- **FR-032**: 历史记录页面必须支持分页功能，默认每页显示 20 条记录
- **FR-033**: 复盘报告中的所有文本内容（裁判总结、发言内容、评分评论）必须支持 Markdown 渲染

### Quality Requirements

- **QR-001**: 所有Agent的输出必须使用结构化的JSON格式，包含必需的字段验证
- **QR-002**: 数据库schema必须定义外键约束确保数据完整性
- **QR-003**: 所有对外接口必须有错误处理和清晰的错误消息
- **QR-004**: 关键代码路径（辩论流程控制、评分计算、投票汇总）必须有单元测试覆盖
- **QR-005**: 所有配置项（模型API密钥、权重参数等）必须通过环境变量或配置文件管理，不得硬编码

### User Experience Requirements

- **UXR-001**: 辩论进度必须实时可见，用户能够在辩论进行中通过流式输出实时看到每个Agent的发言内容（类似观看直播），而不是等待轮次完成后才看到结果
- **UXR-002**: 系统必须提供清晰的方式来展示每一轮的发言和裁判评分
- **UXR-003**: 复盘报告必须格式良好，易于阅读，包含关键信息的可视化（如评分趋势图）
- **UXR-004**: 错误消息必须明确指出问题原因和可能的解决方法
- **UXR-005**: 系统必须支持用户在辩论过程中查看当前状态，包括轮次进度和每轮的简要结果
- **UXR-006**: 用户界面必须使用中文显示，确保用户能够理解所有功能和信息
- **UXR-007**: 辩论消息必须使用画布式布局按轮次分组展示，每轮有清晰的视觉边界和轮次标识
- **UXR-008**: LLM 输出内容必须支持 Markdown 格式渲染，包括列表、粗体、斜体、代码块、引用等格式
- **UXR-009**: 评分查看采用悬浮按钮交互，点击后弹出模态框显示详细评分
- **UXR-010**: 历史记录页面必须支持分页，避免一次性加载过多数据影响性能

### Performance Requirements

- **PR-001**: 单轮辩论（包括LLM调用和裁判评分）必须在3分钟内完成
- **PR-002**: 完整的10轮辩论（不包括用户配置时间）必须在30分钟内完成
- **PR-003**: 数据库查询操作（查询历史记录、单轮详情）必须在1秒内返回
- **PR-004**: 系统必须支持同时运行至少3个独立的辩论会话而不相互干扰
- **PR-005**: LLM API调用失败后的重试等待时间不超过30秒
- **PR-006**: 系统响应时间（用户操作后的反馈）不超过2秒

### Documentation Requirements

- **DR-001**: 所有功能规范、用户文档必须使用中文编写
- **DR-002**: 代码注释和变量名可以使用英文，但关键的公共接口必须有中文文档
- **DR-003**: 技术术语没有合适中文翻译的可以保留英文（如Agent、Prompt、Token等）
- **DR-004**: 必须提供配置示例说明如何配置不同的LLM模型（OpenAI、Claude、Gemini、DeepSeek）
- **DR-005**: 必须提供用户使用指南，说明如何创建辩论、配置模型、查看结果

### Key Entities

- **Debate（辩论会话）**: 代表一次完整的辩论活动，包含辩题、创建时间、状态等属性，与多个Agent、Round、Score、Vote关联
- **Agent（代理）**: 代表参与辩论的AI角色，包括辩手（Debater）、裁判（Judge）、观众（Audience）、主持（Moderator），具有角色、模型配置、立场等属性
- **Round（轮次）**: 代表辩论中的一个回合，属于某个Debate，具有轮次类型（开篇立论、反驳、质询等）和序列号
- **Message（发言）**: 代表某个Agent在某一轮中的发言内容，属于某个Round，包含发言内容和时间戳
- **Score（评分）**: 代表裁判Agent在某一轮对某个Agent的评分，包含逻辑一致性、针对性反驳、表达清晰度、论证有效性四个维度的分数
- **Vote（投票）**: 代表观众Agent在辩论结束后的投票，包含投票立场（Pro/Con）、置信度和投票理由
- **AudienceRequest（观众申请）**: 代表观众Agent在第3-6轮申请下场发言的请求，包含意图、论点、新颖性等属性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在5分钟内完成一个简单辩论的配置并启动（不包括模型API密钥配置）
- **SC-002**: 一个完整的10轮辩论能够在30分钟内自动完成，无需用户干预
- **SC-003**: 裁判Agent的评分输出100%符合预期的JSON格式，包含所有必需字段
- **SC-004**: 系统能够正确识别并记录至少80%的明显犯规行为（如在被禁止的轮次引入新观点）
- **SC-005**: 所有辩论数据100%正确持久化到数据库，无数据丢失
- **SC-006**: 用户查询历史辩论记录时，能够在1秒内获取完整的辩论数据
- **SC-007**: 生成的复盘报告包含胜负结果、关键转折回合、决胜论点、双方盲点、观众视角分歧等所有必需信息
- **SC-008**: 系统能够处理至少2个不同的LLM提供商（如OpenAI和Claude）同时参与辩论
- **SC-009**: 在某个模型API调用失败的情况下，系统能够记录失败并继续完成辩论，成功率不低于95%
- **SC-010**: 用户能够通过复盘报告理解辩论的胜负原因和关键论点，无需查看完整的原始对话

## Assumptions

1. 用户已经拥有所需LLM模型的API访问权限和有效的API密钥
2. 用户对辩论的基本流程和规则有一定了解
3. 系统运行在稳定的网络环境中，能够访问各LLM提供商的API服务
4. 默认的辩论配置为10轮，用户可以在创建会话时自定义
5. 裁判评分和观众投票的默认权重为各50%，用户可以在配置中调整
6. 观众Agent的默认配置为5个不同类型的观众，用户可以自定义数量和类型
7. 系统通过Web界面提供服务，用户使用浏览器访问和使用所有功能
8. 单次辩论的处理时长（30分钟）对于用户是可以接受的
9. 用户可以在Web界面中实时观看正在进行的辩论（流式输出），但不需要支持多人同时观看同一辩论
10. 辩论结果不需要立即同步到外部系统（如数据库导出、API通知等）

## Dependencies

1. 外部LLM API服务的稳定性和可用性（OpenAI、Claude、Gemini、DeepSeek等）
2. SQLite数据库的存储容量限制（单个辩论的数据量预计在几MB级别）
3. 用户提供的API密钥必须具有足够的配额来完成完整辩论
